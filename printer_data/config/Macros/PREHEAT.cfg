[gcode_macro PREHEAT]
gcode:
    {% set bedtemp = params.BED|default(90)|int %}
    {% set chambertemp = params.CHAMBER|default(55)|int %}
    
    {% if printer.heater_bed.temperature < bedtemp or printer.heater_chamber.temperature < chambertemp %}
        M118 Start PREHEAT homing.
        G28
        G1 Z20
        G1 X120 Y120 F7800
        M118 Start PREHEAT.
        M118 Set bed temperature to ({bedtemp} C째).
        M118 Set chamber temperature to ({chambertemp} C째).
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bedtemp}
        SET_HEATER_TEMPERATURE HEATER=chamber TARGET={chambertemp}
        SET_FAN_SPEED FAN=auxiliary_part_cooling_fan SPEED=0.2
        UPDATE_DELAYED_GCODE ID=preheat_delay DURATION=180
    {% else %}
        M118 No PREHEAT needed ({printer.heater_bed.temperature} C째).
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bedtemp}
        SET_HEATER_TEMPERATURE HEATER=chamber TARGET={chambertemp}
    {% endif %}

[delayed_gcode preheat_delay]
gcode:
    {% if printer.extruder.temperature <= printer['heater_generic chamber'].target %}
        M118 Continue PREHEAT until extruder equals chambertemp. Extruder is ({printer.extruder.temperature} C째).
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={printer.heater_bed.target}
        SET_HEATER_TEMPERATURE HEATER=chamber TARGET={printer['heater_generic chamber'].target}
        UPDATE_DELAYED_GCODE ID=preheat_delay DURATION=180
    {% else %}
        M118 PREHEAT finished. Heaters remain on!
        PREHEAT_Beep
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={printer.heater_bed.target}
        SET_HEATER_TEMPERATURE HEATER=chamber TARGET={printer['heater_generic chamber'].target}
    {% endif %}

[gcode_macro PREHEAT_Beep]
gcode:
        SET_PIN PIN=beeper VALUE=1
        G4 P500
        SET_PIN PIN=beeper VALUE=0
        G4 P500
        SET_PIN PIN=beeper VALUE=1
        G4 P500
        SET_PIN PIN=beeper VALUE=0
        G4 P500
        SET_PIN PIN=beeper VALUE=1
        G4 P500
        SET_PIN PIN=beeper VALUE=0
        G4 P1000
        SET_PIN PIN=beeper VALUE=1
        G4 P500
        SET_PIN PIN=beeper VALUE=0
        G4 P500
        SET_PIN PIN=beeper VALUE=1
        G4 P500
        SET_PIN PIN=beeper VALUE=0
        G4 P500
        SET_PIN PIN=beeper VALUE=1
        G4 P500
        SET_PIN PIN=beeper VALUE=0